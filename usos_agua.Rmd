---
title: "Usos de los recursos hidricos en el Uruguay"
author: "Facundo Morini, Mariana Ceresa"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning =FALSE)
library(here)
library(tidyverse)
```

# Introducción

A lo largo de los últimos años, el cambio climático y las sequías han impactado significativamente a nuestro país, generando una creciente preocupación en torno al uso del agua. En este contexto, resulta fundamental analizar el aprovechamiento de los recursos hídricos en Uruguay. El presente trabajo tiene como objetivo principal explorar e informar sobre los diversos usos que se le da al agua en nuestro país. Para ello, se utilizarán los datos abiertos disponibles proporcionados por la Dirección Nacional del Agua (DINAGUA), específicamente el registro de empresas que realizan solicitudes para explotar los recursos hídricos.

Dentro de este estudio, nos planteamos responder a preguntas fundamentales, tales como:

1. ¿En qué se utiliza la mayor parte del agua que se solicita extraer?
2. ¿Qué sectores de la actividad requieren mayores volúmenes de agua?
3. ¿Qué zonas del país presentan mayores demanda de uso?

Para abordar estas preguntas, realizaremos un análisis de los datos disponibles utilizando las diversas herramientas que proporciona R para el análisis de datos. Buscaremos utilizar y dar visibilidad a la biblioteca Geouy, que facilita el manejo de datos geograficos relacionados con Uruguay de manera sencilla.
Además, crearemos una aplicación utilizando la biblioteca Shiny, que permitirá visualizar de forma interactiva los resultados obtenidos en el informe. 
Por último, crearemos un modelo predictivo con el objetivo de predecir el uso del agua utilizando diversas variables de respuesta presentes en los datos. 

# Datos

```{r, echo=FALSE,message=FALSE}
datos <- read_csv2(here("Datos","aprovechamientos_2023.csv"))
datos_19 <- read_csv2(here("Datos","aprovechamientos_2019.csv"))
```

```{r, include=FALSE}
summary(datos)
```

```{r}
datos_l <- datos %>%
           select(-"Regional",-"Estado",-"Tipo Solicitud",-"Fecha Solicitud",-"Fecha Resolución",-"Fecha Inscripción",
                  -"Fecha Vencimiento",-"produccion") %>%
           rename("cod_reg"= "nro_gex","nom_reg"= "Nombre","dpto"= "departamento",
                  "vol_anual"="Volumen Anual (m3)","tipo_ext"="Categoría","mes_anio"="Meses/Año") %>%
           rename_all(tolower) %>%
           mutate(dpto =factor(dpto),uso =factor(uso),destino =factor(destino)) %>%
           mutate(codcuenca_nv1=factor(substr(codcuenca, 1, 1))) %>%
           mutate(tipo_ext = str_to_title(tipo_ext),nom_reg=toupper(nom_reg)) %>%
           mutate(tipo_ext = case_when(tipo_ext == "Pozoestudio" ~ "Pozo",.default=tipo_ext)) %>%
           mutate(tipo_ext = factor(tipo_ext)) %>%
           mutate(inicio = as.Date(inicio)) %>%
           mutate(fin = as.Date(fin)) %>%
           mutate(dias_permiso = difftime(fin, inicio, units = "days")) %>%
           mutate(vol_anual = vol_anual/1e6)

datos_coord <- datos_19 %>%
               filter(Lat < 0,Lon < 0) %>%
               rename("cod_reg"="Nro. GEX","lat"="Lat","lon"="Lon") %>%
               select(cod_reg,lat,lon) 

datos_l <- left_join(datos_l,datos_coord,by="cod_reg")
```

Como se mencionó, los datos utilizados pertenecen a la Dirección Nacional del Agua. Estos datos comprenden el registro de todas las empresas y entes publicos que realizan extracciones de agua para diversos usos productivos o abastecimiento a la poblacion. Los datos abarca un total de 5405 registros que se encuentran actualmente habilitados a la explotacion de recursos hidricos. 

Las principales variables de interes a analizar de los datos son:

```{r,echo=FALSE}
library(kableExtra)
meta_datos <- tibble("Nombre Variable" = names(datos_l),
                  "Descripción" = c("Refiere al codigo identificador de la solicitud de extraccion frente a la DINAGUA.",
                                   "Nombre de la empresa, ente o persona registrada.", 
                                   "Departamento donde se encuentra la obra de extracción", 
                                   "Hace referencia al propósito o destino que se le dará al agua. Los usos se clasifican en consumo humano, uso industrial, riego, otros usos agropecuarios y otros usos adicionales (turismo y recreación, control de incendios, comercio y servicios).", 
                                   "Detalla el lugar o fin específico donde se utilizará el agua, por ejemplo, en el caso del riego, se especifica el tipo de cultivo.", 
                                   "Indica el volumen máximo de agua permitido para la extracción. Este valor depende en parte, por el tipo de obra utilizada para la extracción.", 
                                   "Fecha en la que se inicia la solicitud de extracción",
                                   "Fecha en la que caduca el permiso de extracción",
                                   "Se refiere al tipo de estructura utilizada para la extracción del agua, que puede ser a través de represas, tomas directas en ríos o pozos, entre otras opciones comunes.", 
                                   "Cantidad de meses en el año que se usa el agua que se extrae", 
                                   "Permite identificar la cuenca hidrográfica de nivel 2  a la cual se está realizando la extracción.", 
                                   "Permite identificar la cuenca hidrográfica de nivel 1 a la cual se está realizando la extracción.",
                                   "Diferencia en días entre la fecha inicio y fin", 
                                   "Coordenadas de latitud de la obra de extraccion", 
                                   "Coordenadas de longitud de la obra de extraccion"))

```

```{r, echo=FALSE, results='asis'}
kable(meta_datos, format = "markdown", col.names = c("Nombre Variable", "Descripción")) %>%
  kable_styling(font_size = 5) 
```

```{r, echo = FALSE,message=FALSE}
library(geouy)

mapa <- load_geouy("Cuencas hidro N2") %>%
         mutate(nombrec2=iconv(nombrec2, from = "ISO-8859-1", to = "UTF-8"),
         popup=iconv(popup, from = "ISO-8859-1", to = "UTF-8"))

# Cantidad de registros por cuenca
reg_cuenca <- datos_l %>%
              group_by(codcuenca) %>%
              summarise(n_reg=n())

# Uso con mayor volumen por cuenca
uso_cuenca <- datos_l %>%
              group_by(codcuenca,uso) %>%
              summarise(vol_anual_uso = sum(vol_anual)) %>%
              slice_max(order_by = vol_anual_uso, n = 1) 

# Destino con mayor volumen por cuenca          
dest_cuenca <- datos_l %>%
               group_by(codcuenca,destino) %>%
               summarise(vol_anual_dest = sum(vol_anual)) %>%
               slice_max(order_by = vol_anual_dest, n = 1) 
              
# Volumen total por cuenca
vol_cuenca <- datos_l %>% 
              group_by(codcuenca) %>%
              summarise(vol_anual = sum(vol_anual))

datos_cuenca <- left_join(mapa, reg_cuenca, by = "codcuenca") %>% 
                left_join(uso_cuenca, by = "codcuenca") %>%
                left_join(dest_cuenca, by = "codcuenca") %>%
                left_join(vol_cuenca, by = "codcuenca")
```

## Cantidad de registros por uso

```{r,echo=FALSE}
reg_uso <- datos_l %>%
           group_by(uso) %>%
           ggplot() + geom_bar(aes(x=fct_infreq(uso),fill=uso)) + 
           scale_y_continuous(name="Cantidad de registros por uso") + scale_x_discrete(name="Usos") + coord_flip() +                         theme(legend.position = "none")
```

```{r}
#Gráfico de barras que muestra la cantidad de solicitudes agrupadas según su uso
reg_uso
```

## Cuencas hidrograficas catalogadas por uso mayoritario

```{r}
plotm_uso <- ggplot() + geom_sf(data=datos_cuenca,aes(fill=uso)) + 
             theme(axis.text = element_blank(),axis.ticks = element_blank()) + scale_fill_discrete(name="Uso mayoritario")
```

```{r}
# Mapa fraccionado por cuencas nivel 2, reflejando el uso que tiene el mayor volumen máximo de agua autorizado para cada cuenca
plotm_uso
```

## Cuencas hidrográficas catalogadas por destino mayoritario y volumen anual disponible

```{r}
plotm_dest <- ggplot(data = datos_cuenca) +
  geom_sf(aes(fill = destino)) +
  stat_sf_coordinates(aes(size = vol_anual_dest), alpha = 0.5, color="darkblue") +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank()) +
  scale_fill_discrete(name = "Destino") +
  scale_size_continuous(name = "Volumen Anual (millones de m3)", range = c(1,11))
```

```{r}
# Mapa fraccionado por cuencas nivel 2, reflejando el destino que tiene el mayor volumen máximo de agua autorizado para cada cuenca, y el volumen total según el máximo uso
plotm_dest
```
## Cuencas hidrograficas catalogadas por volumen anual disponible

```{r}
plotm_vol <- ggplot() + geom_sf(data=datos_cuenca,aes(fill=vol_anual)) + scale_fill_viridis_c(name="Volumen Anual(millones de m3)")  +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank()) 
```

```{r}
#Mapa fraccionado por cuencas nivel 2, que refleja el volumen total autorizado para cada una
plotm_vol
```

## Volumen anual permitido distribuido por uso 

```{r,echo=FALSE,eval=FALSE}
library(networkD3)

# Suma total de volumen por uso
uso_sankey <- datos_l %>%
              group_by(uso) %>%
              summarise(vol_anual = sum(vol_anual))

# Suma total de volumen por destino, para el uso Riego
dest_sankey <- datos_l %>%
               filter(uso == "Riego") %>%
               mutate(destino = case_when(destino %in% c("Caña de azúcar","Otros","Hortalizas") ~ "Otros cultivos",
                                          .default = destino)) %>%
               group_by(destino) %>%
               summarise(vol_anual = sum(vol_anual))

links_sankey <- data.frame(
  source = c(rep("Volumen Anual Disponible",length(uso_sankey$uso)),
             rep("Riego",length(dest_sankey$destino))), 
  target = c(levels(uso_sankey$uso),dest_sankey$destino), 
  value = c(uso_sankey$vol_anual,dest_sankey$vol_anual)  
)

nodos_sankey <- data.frame(
  name=c(as.character(links_sankey$source), 
  as.character(links_sankey$target)) %>% unique()
)

links_sankey$IDsource <- match(links_sankey$source, nodos_sankey$name)-1 
links_sankey$IDtarget <- match(links_sankey$target, nodos_sankey$name)-1

sankey_vol <- sankeyNetwork(Links = links_sankey, Nodes = nodos_sankey,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name", 
              sinksRight=FALSE)

sankey_vol
```


# MODELOS 

Se construye un modelo para determinar el Uso que tendrá la soliciud. Para ésto agrupamos los usos "Otros Usos", "Otros Usos Agropecuarios" y "Usos no consuntivos" en uno, quedando la clasificación de la siguiente forma:

  - Riego
  - Consumo humano
  - Industrial
  - Otros

```{r}
library(rpart)
library(rpart.plot)
library(caret)
library(randomForest)

set.seed(358)

datos_mod <- datos_l %>%
             select(uso,vol_anual,mes_anio,tipo_ext, codcuenca_nv1, codcuenca,dias_permiso,dpto) %>%
             mutate(uso = case_when(uso %in% c("Usos No Consuntivos","Consumo Humano")~"Otros Usos",.default=uso)) %>%
             na.omit() %>%
             mutate(uso=factor(uso))

# Separamos 70% para entrenamient, 30% testeo
datos_training <- sample_frac(datos_mod, .7)
datos_test <- setdiff(datos_mod, datos_training)
```

## Arbol 

```{r}
# Usamos rpart para estimar el árbol
arbol_1 <- rpart(formula = uso ~ dpto + vol_anual + tipo_ext + dias_permiso + codcuenca_nv1, data = datos_training)
```

```{r}
rpart.plot(arbol_1)
```

```{r}
# Realizamos las predicciones y mostramos la Matriz de resultados
prediccion_1 <- predict(arbol_1, newdata = datos_test, type = "class")
confusionMatrix(prediccion_1, datos_test[["uso"]])
```

```{r}
#Vamos a tratar el desbalance

tabla_usos <- datos_mod %>%
              group_by(uso) %>%
              summarise(cantidad=n()) %>%
              mutate(porcentaje = round(((cantidad/sum(cantidad))*100), 2),
                     proporcion = round((cantidad/sum(cantidad)), 4)) %>%
              select(uso,proporcion) %>% 
              arrange(., desc(proporcion))

datos_arbol_2 <- left_join(datos_training, tabla_usos, by="uso")
```

```{r}
tabla_usos 
```


```{r}
arbol_2 <- rpart(formula = uso ~ dpto + vol_anual + tipo_ext + dias_permiso + codcuenca_nv1, data = datos_arbol_2, weight = proporcion)

rpart.plot(arbol_2)
```

```{r}
prediccion_2 <- predict(arbol_2, newdata = datos_test, type = "class")
confusionMatrix(prediccion_2, datos_test[["uso"]])
```

No se observa una mejor performance, por lo que vamos a probar con un Random Forest

## Random Forest

```{r}
rf_1 <- randomForest(uso ~ codcuenca + vol_anual + tipo_ext + dias_permiso + codcuenca_nv1, data= datos_training, ntree = 150)
prediccion_3 <- predict(rf_1, newdata = datos_test, type = "class")
confusionMatrix(prediccion_3, datos_test[["uso"]])
```

