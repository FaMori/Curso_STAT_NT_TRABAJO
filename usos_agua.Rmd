---
title: "Usos de los recursos hidricos en el Uruguay"
author: "Facundo Morini, Mariana Ceresa"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning =FALSE)
library(here)
library(readxl)
library(tidyverse)
library(geouy)
library(xtable)
library(rpart)
library(rpart.plot)
library(caret)
library(randomForest)
```

# Introducción

A lo largo de los últimos años, el cambio climático y las sequías han impactado significativamente a nuestro país, generando una creciente preocupación en torno al uso del agua. En este contexto, resulta fundamental analizar el aprovechamiento de los recursos hídricos en Uruguay. El presente trabajo tiene como objetivo principal explorar e informar sobre los diversos usos que se le da al agua en nuestro país. Para ello, se utilizarán los datos abiertos disponibles proporcionados por la Dirección Nacional del Agua (DINAGUA), específicamente el registro de empresas que realizan solicitudes para explotar los recursos hídricos.

Dentro de este estudio, nos planteamos responder a preguntas fundamentales, tales como:

1. ¿En qué se utiliza la mayor parte del agua que se solicita extraer?
2. ¿Qué sectores de la actividad requieren mayores volúmenes de agua?
3. ¿Qué zonas del país presentan mayores demanda de uso?

Para abordar estas preguntas, realizaremos un análisis de los datos disponibles utilizando las diversas herramientas que proporciona R para el análisis de datos. Buscaremos utilizar y dar visibilidad a la biblioteca Geouy, que facilita el manejo de datos geograficos relacionados con Uruguay de manera sencilla.
Además, crearemos una aplicación utilizando la biblioteca Shiny, que permitirá visualizar de forma interactiva los resultados obtenidos en el informe. 
Por último, crearemos un modelo predictivo con el objetivo de predecir el uso del agua utilizando diversas variables de respuesta presentes en los datos. 

# Datos

```{r}
datos <- read_csv2(here("Datos","aprovechamientos_2023.csv"))
datos_19 <- read_csv2(here("Datos","aprovechamientos_2019.csv"))
```
```{r, include=FALSE}
summary(datos)
summary(datos_19)
```

```{r}
datos_l <- datos %>%
           select(-"Regional",-"Estado",-"Tipo Solicitud",-"Fecha Solicitud",-"Fecha Resolución",-"Fecha Inscripción",
                  -"Fecha Vencimiento",-"produccion") %>%
           rename("cod_reg"= "nro_gex","nom_reg"= "Nombre","dpto"= "departamento",
                  "vol_anual"="Volumen Anual (m3)","tipo_ext"="Categoría","mes_anio"="Meses/Año") %>%
           rename_all(tolower) %>%
           mutate(dpto =factor(dpto),uso =factor(uso),destino =factor(destino),
                  codcuenca=factor(codcuenca)) %>%
           mutate(codcuenca_nv1=factor(substr(codcuenca, 1, 1))) %>%
           mutate(tipo_ext = str_to_title(tipo_ext),nom_reg=toupper(nom_reg)) %>%
           mutate(tipo_ext = case_when(tipo_ext == "Pozoestudio" ~ "Pozo",.default=tipo_ext)) %>%
           mutate(tipo_ext = factor(tipo_ext)) %>%
           mutate(inicio = as.Date(inicio)) %>%
           mutate(fin = as.Date(fin)) %>%
           mutate(dif_dias_ini_fin = difftime(fin, inicio, units = "days"))


datos_coord <- datos_19 %>%
               filter(Lat < 0) %>%
               filter(Lon < 0) %>% 
               rename("cod_reg"="Nro. GEX","lat"="Lat","lon"="Lon") %>%
               select(cod_reg,lat,lon)

datos_l <- left_join(datos_l,datos_coord,by="cod_reg")
```

Como se mencionó, los datos utilizados pertenecen a la Dirección Nacional del Agua. Estos datos comprenden el registro de todas las empresas y entes publicos que realizan extracciones de agua para diversos usos productivos o abastecimiento a la poblacion. Los datos abarca un total de 5405 registros que se encuentran actualmente habilitados a la explotacion de recursos hidricos. 

Las principales variables de interes a analizar de los datos son:

```{r,echo=FALSE}
t_datos <- tibble("Nombre Variable" = names(datos_l),
                  "Descripción" = c("Refiere al codigo identificador de la solicitud de extraccion frente a la DINAGUA.",
                                   "Nombre de la empresa, ente o persona registrada.", 
                                   "Departamento donde se encuentra la obra de extracción", 
                                   "Hace referencia al propósito o destino que se le dará al agua. Los usos se clasifican en consumo humano, uso industrial, riego, otros usos agropecuarios y otros usos adicionales (turismo y recreación, control de incendios, comercio y servicios).", 
                                   "Detalla el lugar o fin específico donde se utilizará el agua, por ejemplo, en el caso del riego, se especifica el tipo de cultivo.", 
                                   "Indica el volumen máximo de agua permitido para la extracción. Este valor depende en parte, por el tipo de obra utilizada para la extracción.", 
                                   "Fecha en la que se inicia la solicitud de extracción",
                                   "Fecha en la que caduca el permiso de extracción",
                                   "Se refiere al tipo de estructura utilizada para la extracción del agua, que puede ser a través de represas, tomas directas en ríos o pozos, entre otras opciones comunes.", 
                                   "Cantidad de meses en el año que se usa el agua que se extrae", 
                                   "Permite identificar la cuenca hidrográfica de nivel 2  a la cual se está realizando la extracción.", 
                                   "Permite identificar la cuenca hidrográfica de nivel 1 a la cual se está realizando la extracción.",
                                   "Diferencia en días entre la fecha inicio y fin", 
                                   "Coordenadas de latitud de la obra de extraccion", 
                                   "Coordenadas de longitud de la obra de extraccion"))
meta_datos <- xtable(t_datos,include.rownames = FALSE)
```

```{r, echo=FALSE, results='asis'}
print(meta_datos,size = "\\footnotesize",comment=FALSE)
```

```{r}
map_c <- load_geouy("Cuencas hidro N2") %>%
         mutate(nombrec2=iconv(nombrec2, from = "ISO-8859-1", to = "UTF-8"),
         popup=iconv(popup, from = "ISO-8859-1", to = "UTF-8"),codcuenca=factor(codcuenca))

uso_c <- datos_l %>%
         group_by(codcuenca,uso) %>%
         summarise(n_uso=n()) %>%
         slice_max(order_by = n_uso, n = 1) 

reg_c <- datos_l %>%
         group_by(codcuenca) %>%
         summarise(n_reg=n())

destagr_c <- datos_l %>%
             filter(uso %in% c("Riego","Otros usos agropecuarios")) %>%
             group_by(codcuenca,destino) %>%
             summarise(n_dest_agro=n()) %>%
             rename("dest_agro"="destino") %>%
             slice_max(order_by = n_dest_agro, n = 1) 
              
vol_c <- datos_l %>% 
         group_by(codcuenca) %>%
         summarise(vol_anual = sum(vol_anual))

datos_c <- left_join(map_c, uso_c, by = "codcuenca") %>% 
           left_join(destagr_c, by = "codcuenca") %>%
           left_join(reg_c, by = "codcuenca") %>%
           left_join(vol_c, by = "codcuenca")
```


## Cuencas hidrograficas catalogadas por uso mayoritario

```{r}
plotm_uso <- ggplot() + geom_sf(data=datos_c,aes(fill=uso))
plotm_uso
```


```{r}
plotm_destagr <- ggplot() + geom_sf(data=datos_c,aes(fill=dest_agro))
plotm_destagr
```


```{r}
plotm_vol <- ggplot() + geom_sf(data=datos_c,aes(fill=vol_anual)) + scale_fill_viridis_c(name="Volumen anual disponible (m3)",end = 0.9)
plotm_vol
```

# Principales usos 

## Numero de registros por uso

```{r,echo=FALSE}
reg_uso <- datos_l %>%
           group_by(uso) %>%
           ggplot() + geom_bar(aes(x=fct_infreq(uso),fill=uso)) + 
           scale_y_continuous(name="Cantidad de registros por uso") + scale_x_discrete(name="Usos") + coord_flip() +                         theme(legend.position = "none")
```

```{r}
reg_uso
```
# Riego

## Cantidad de registros por cultivo

```{r,echo=FALSE}
reg_cult <- datos_l %>%
           filter(uso == "Riego",!destino %in% c("Sistema de riego","Otros")) %>%
           group_by(destino) %>%
           ggplot() + geom_bar(aes(x=fct_infreq(destino),fill=destino)) + 
           scale_y_continuous(name="Cantidad de registros por cultivo") + scale_x_discrete(name="Cultivo") + coord_flip() +                         theme(legend.position = "none")
```

```{r,echo=FALSE}
reg_cult
```
## Volumenes anuales por cultivo

```{r,echo=FALSE}
vol_cult <- datos_l %>%
           filter(uso == "Riego",!destino %in% c("Sistema de riego","Otros")) %>%
           group_by(destino) %>%
           summarise(vol = sum(vol_anual)) %>%
           ggplot() + geom_bar(aes(x=reorder(destino,vol,decreasing = TRUE),y=vol,fill=destino),stat="identity") + 
           scale_y_continuous(name="Volumen anual disponible por cultivo (m3)") + scale_x_discrete(name="Cultivo") + coord_flip() + theme(legend.position = "none")
```

```{r,echo=FALSE}
vol_cult
```
```{r}
tabla_usos <- datos_l %>%
  select(uso) %>%
  group_by(uso) %>%
  summarise(Cantidad=n()) %>%
  mutate(Porcentaje = round(((Cantidad/sum(Cantidad))*100), 2)) %>%
  mutate(Proporcion = round((Cantidad/sum(Cantidad)), 4)) %>%
  arrange(., desc(Porcentaje))

tabla_usos
```

```{r}
set.seed(623)

# Dividimos la muestra en subconjunto de entrenamiento y test
training <- sample_frac(datos_l, .7) 
test <- setdiff(datos_l, training)
```

```{r}
# Usamos rpart para estimar el árbol
arbol_1 <- rpart(formula = uso ~ dpto + vol_anual + tipo_ext + dif_dias_ini_fin, data = training)
```
```{r}
rpart.plot(arbol_1)
```

```{r}
prediccion_1 <- predict(arbol_1, newdata = test, type = "class")
confusionMatrix(prediccion_1, test[["uso"]])
```

Vamos a tratar el desbalance
```{r}
training <- left_join(training, tabla_usos, by="uso")
```

```{r}
arbol_2 <- rpart(formula = uso ~ dpto + vol_anual + tipo_ext + dif_dias_ini_fin, data = training, weight = Proporcion)

rpart.plot(arbol_2)
```

```{r}
prediccion_2 <- predict(arbol_2, newdata = test, type = "class")
confusionMatrix(prediccion_2, test[["uso"]])
```

No se observa una mejor performance, por lo que vamos a probar con un Random Forest

```{r}
print(paste("Cantidad de registros totales: ", nrow(datos_l)))

datos_sin_na <- datos_l %>%
  filter(!is.na(dpto) & !is.na(vol_anual) & !is.na(tipo_ext) & !is.na(dif_dias_ini_fin) & dif_dias_ini_fin >= 0)

print(paste("Cantidad de registros sin NA: ", nrow(datos_sin_na)))
```
```{r}
set.seed(897)

# Divide muestra en subconjunto de entrenamiento y test
training_rf <- sample_frac(datos_sin_na, .7) 
test_rf <- setdiff(datos_sin_na, training_rf)

rf_1 <- randomForest(uso ~ dpto + vol_anual + tipo_ext + dif_dias_ini_fin, data= training_rf, ntree = 150)
prediccion_3 <- predict(rf_1, newdata = test_rf, type = "class")
confusionMatrix(prediccion_3, test_rf[["uso"]])

```

Probemos clasificar en:
- Riego
- Otros usos agrpecuarios
- Industrial
- Otros

```{r}
datos_nueva_clasificacion <- datos_sin_na %>% mutate(uso = as.character(uso))
datos_nueva_clasificacion <- mutate(datos_nueva_clasificacion, uso = ifelse(uso %in% c("Riego", "Otros Usos Agropecuarios", "Industrial"), uso, "Otros")) %>%
  mutate(uso = factor(uso))

tabla_usos_nc <- datos_nueva_clasificacion %>%
  select(uso) %>%
  group_by(uso) %>%
  summarise(Cantidad=n()) %>%
  mutate(Porcentaje = round(((Cantidad/sum(Cantidad))*100), 2)) %>%
  mutate(Proporcion = round((Cantidad/sum(Cantidad)), 4)) %>%
  arrange(., desc(Porcentaje))

tabla_usos_nc
```

```{r}
set.seed(897)

# Dividimos la muestra en subconjunto de entrenamiento y test
training_nc <- sample_frac(datos_nueva_clasificacion, .7) 
test_nc <- setdiff(datos_nueva_clasificacion, training_nc)
```

```{r}
rf_nc_1 <- randomForest(uso ~ dpto + vol_anual + tipo_ext + dif_dias_ini_fin, data= training_nc, ntree = 180)
prediccion_nc_1 <- predict(rf_nc_1, newdata = test_nc, type = "class")
confusionMatrix(prediccion_nc_1, test_nc[["uso"]])
```
